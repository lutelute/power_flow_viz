<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊΩÆÊµÅË®àÁÆóÂèØË¶ñÂåñ - MATPOWERÊ∫ñÊã†</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-surface: #1a1a25;
            --bg-hover: #252535;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --accent-pink: #ec4899;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #2d2d3d;
            --success: #22c55e;
            --warning: #eab308;
            --error: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans JP', 'JetBrains Mono', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-dark) 100%);
            border-bottom: 1px solid var(--border);
            padding: 20px 30px;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text h1 {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .logo-text span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .matpower-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-surface);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--accent-cyan);
            border: 1px solid var(--border);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px 30px;
        }

        .control-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group select,
        .control-group input[type="number"] {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            min-width: 180px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: var(--accent-cyan); color: var(--bg-dark); }
        .btn-success { background: var(--accent-green); color: var(--bg-dark); }
        .btn-warning { background: var(--accent-orange); color: var(--bg-dark); }
        .btn-secondary { background: var(--bg-surface); color: var(--text-primary); border: 1px solid var(--border); }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .stat-card.success .stat-value { color: var(--success); }
        .stat-card.warning .stat-value { color: var(--warning); }
        .stat-card.error .stat-value { color: var(--error); }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .viz-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .viz-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-surface);
        }

        .viz-title {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .viz-body {
            padding: 15px;
            height: 380px;
            position: relative;
        }

        .viz-body canvas { width: 100%; height: 100%; }

        .full-width { grid-column: 1 / -1; }
        .full-width .viz-body { height: 300px; }

        .table-container { max-height: 350px; overflow-y: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-surface);
            color: var(--text-secondary);
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:hover { background: var(--bg-hover); }

        .bus-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .bus-type.slack { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .bus-type.pv { background: rgba(245, 158, 11, 0.2); color: var(--accent-orange); }
        .bus-type.pq { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }

        .reference-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .reference-section h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--accent-cyan);
        }

        .reference-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .ref-card {
            background: var(--bg-surface);
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid var(--accent-purple);
        }

        .ref-card h4 {
            font-size: 0.85rem;
            color: var(--accent-orange);
            margin-bottom: 8px;
        }

        .ref-card p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .ref-card code {
            background: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-cyan);
        }

        .ref-card a { color: var(--accent-cyan); text-decoration: none; }
        .ref-card a:hover { text-decoration: underline; }

        .equation-box {
            background: var(--bg-surface);
            border-radius: 8px;
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.8;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .eq-var { color: var(--accent-orange); }
        .eq-comment { color: var(--text-muted); font-style: italic; }

        .legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <div class="logo-text">
                    <h1>Power Flow Visualizer</h1>
                    <span>ÊΩÆÊµÅË®àÁÆó„Ç¢„É´„Ç¥„É™„Ç∫„É†ÂèØË¶ñÂåñ„ÉÑ„Éº„É´</span>
                </div>
            </div>
            <div class="matpower-badge">
                <span>üìö</span>
                <span>MATPOWER 7.1 Ê∫ñÊã† | IEEE Test Cases</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="control-panel">
            <div class="control-row">
                <div class="control-group">
                    <label>„ÉÜ„Çπ„Éà„Ç±„Éº„Çπ</label>
                    <select id="caseSelect">
                        <option value="case2">2-bus Simple</option>
                        <option value="case5">5-bus Example</option>
                        <option value="case9" selected>IEEE 9-bus (WSCC)</option>
                        <option value="case14">IEEE 14-bus</option>
                        <option value="case30">IEEE 30-bus</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>„Ç¢„É´„Ç¥„É™„Ç∫„É†</label>
                    <select id="algoSelect">
                        <option value="nr">Newton-Raphson (Ê•µÂ∫ßÊ®ô)</option>
                        <option value="fdxb">Fast Decoupled XB</option>
                        <option value="gs">Gauss-Seidel</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ÂèéÊùüÂà§ÂÆö (p.u.)</label>
                    <select id="tolSelect">
                        <option value="1e-4">10‚Åª‚Å¥</option>
                        <option value="1e-6" selected>10‚Åª‚Å∂</option>
                        <option value="1e-8">10‚Åª‚Å∏</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ÊúÄÂ§ßÂèçÂæ©ÂõûÊï∞</label>
                    <input type="number" id="maxIterInput" value="30" min="5" max="200">
                </div>
                <div class="control-group">
                    <label>ÈÄüÂ∫¶</label>
                    <select id="speedSelect">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="2">2x</option>
                        <option value="5">5x</option>
                        <option value="0">Áû¨ÊôÇ</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="runBtn">‚ñ∂ ÂÆüË°å</button>
                    <button class="btn btn-warning" id="stepBtn">‚è≠ „Çπ„ÉÜ„ÉÉ„Éó</button>
                    <button class="btn btn-secondary" id="resetBtn">‚Ü∫ „É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-card" id="iterCard">
                <div class="stat-value" id="iterValue">0</div>
                <div class="stat-label">ÂèçÂæ©ÂõûÊï∞</div>
            </div>
            <div class="stat-card" id="errorCard">
                <div class="stat-value" id="errorValue">-</div>
                <div class="stat-label">ÊúÄÂ§ßË™§Â∑Æ (p.u.)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="busCount">-</div>
                <div class="stat-label">„Éé„Éº„ÉâÊï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="branchCount">-</div>
                <div class="stat-label">„Éñ„É©„É≥„ÉÅÊï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="genCount">-</div>
                <div class="stat-label">Áô∫ÈõªÊ©üÊï∞</div>
            </div>
            <div class="stat-card" id="statusCard">
                <div class="stat-value" id="statusValue">ÂæÖÊ©ü‰∏≠</div>
                <div class="stat-label">Áä∂ÊÖã</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="viz-card">
                <div class="viz-header">
                    <div class="viz-title">üîå Á≥ªÁµ±Âõ≥</div>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-green);"></div>Slack</div>
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-orange);"></div>PV</div>
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-blue);"></div>PQ</div>
                    </div>
                </div>
                <div class="viz-body">
                    <canvas id="networkCanvas"></canvas>
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-header">
                    <div class="viz-title">üìà ÂèéÊùüÊõ≤Á∑ö</div>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-cyan);"></div>PË™§Â∑Æ</div>
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-pink);"></div>QË™§Â∑Æ</div>
                    </div>
                </div>
                <div class="viz-body">
                    <canvas id="convergenceCanvas"></canvas>
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-header">
                    <div class="viz-title">üìä ÈõªÂúß„Éó„É≠„Éï„Ç°„Ç§„É´</div>
                </div>
                <div class="viz-body">
                    <canvas id="voltageCanvas"></canvas>
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-header">
                    <div class="viz-title">üßÆ „É§„Ç≥„Éì„Ç¢„É≥Ë°åÂàóÔºà„Çπ„Éë„Éº„ÇπÊßãÈÄ†Ôºâ</div>
                </div>
                <div class="viz-body">
                    <canvas id="jacobianCanvas"></canvas>
                </div>
            </div>

            <div class="viz-card full-width">
                <div class="viz-header">
                    <div class="viz-title">üìã „Éé„Éº„Éâ„Éá„Éº„Çø (MATPOWERÂΩ¢Âºè)</div>
                </div>
                <div class="viz-body" style="height: auto; max-height: 350px; padding: 0;">
                    <div class="table-container">
                        <table id="busTable">
                            <thead>
                                <tr>
                                    <th>Bus</th>
                                    <th>Type</th>
                                    <th>|V| (p.u.)</th>
                                    <th>Œ¥ (deg)</th>
                                    <th>P_gen (MW)</th>
                                    <th>Q_gen (MVAr)</th>
                                    <th>P_load (MW)</th>
                                    <th>Q_load (MVAr)</th>
                                    <th>ŒîP (p.u.)</th>
                                    <th>ŒîQ (p.u.)</th>
                                </tr>
                            </thead>
                            <tbody id="busTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="reference-section">
            <h3>üìù ÁèæÂú®„ÅÆË®àÁÆó„Çπ„ÉÜ„ÉÉ„Éó</h3>
            <div class="equation-box" id="equationBox">„Ç±„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶ÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

MATPOWERÊ∫ñÊã†„ÅÆÊΩÆÊµÅË®àÁÆó„ÇíÂÆüË°å„Åó„Åæ„ÅôÔºö
- Newton-RaphsonÊ≥ï: 2Ê¨°ÂèéÊùü„ÄÅ„É§„Ç≥„Éì„Ç¢„É≥Ë°åÂàó„ÇíÊØéÂèçÂæ©„ÅßÊõ¥Êñ∞
- Fast DecoupledÊ≥ï: P-Œ¥, Q-VÂàÜÈõ¢„ÄÅB', B''Ë°åÂàó„ÅØÂõ∫ÂÆö
- Gauss-SeidelÊ≥ï: 1Ê¨°ÂèéÊùü„ÄÅ„É°„É¢„É™ÂäπÁéá„ÅåËâØ„ÅÑ</div>
        </div>

        <div class="reference-section">
            <h3>üìö MATPOWER „É™„Éï„Ç°„É¨„É≥„Çπ</h3>
            <div class="reference-grid">
                <div class="ref-card">
                    <h4>„Éá„Éº„ÇøÂΩ¢Âºè</h4>
                    <p>
                        MATPOWER CaseÂΩ¢Âºè„Å´Ê∫ñÊã†:<br>
                        <code>mpc.bus</code> - „Éé„Éº„Éâ„Éá„Éº„Çø (BUS_I, TYPE, PD, QD, ...)<br>
                        <code>mpc.gen</code> - Áô∫ÈõªÊ©ü„Éá„Éº„Çø (GEN_BUS, PG, QG, ...)<br>
                        <code>mpc.branch</code> - „Éñ„É©„É≥„ÉÅ„Éá„Éº„Çø (F_BUS, T_BUS, R, X, B, ...)
                    </p>
                </div>
                <div class="ref-card">
                    <h4>Newton-RaphsonÊ≥ï</h4>
                    <p>
                        MATPOWER <code>newtonpf.m</code> Ê∫ñÊã†:<br>
                        „É§„Ç≥„Éì„Ç¢„É≥: <code>dSbus_dV.m</code><br>
                        Êõ¥Êñ∞: [ŒîŒ¥; ŒîV] = -J‚Åª¬π[ŒîP; ŒîQ]<br>
                        ÂèéÊùüÂà§ÂÆö: max(|ŒîP|, |ŒîQ|) &lt; Œµ
                    </p>
                </div>
                <div class="ref-card">
                    <h4>Fast DecoupledÊ≥ï</h4>
                    <p>
                        MATPOWER <code>fdpf.m</code> Ê∫ñÊã†:<br>
                        B' √ó ŒîŒ¥ = ŒîP/V (XB: B' from Bbus)<br>
                        B" √ó ŒîV = ŒîQ/V (XB: B" from Bbus)
                    </p>
                </div>
                <div class="ref-card">
                    <h4>ÂèÇËÄÉÊñáÁåÆ</h4>
                    <p>
                        R. D. Zimmerman, C. E. Murillo-S√°nchez (2020)<br>
                        <a href="https://matpower.org" target="_blank">MATPOWER User's Manual, Version 7.1</a><br>
                        <a href="https://github.com/MATPOWER/matpower" target="_blank">GitHub: MATPOWER/matpower</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ============================================================
    // MATPOWER Test Case Data (IEEE Standard)
    // ============================================================
    const MATPOWER_CASES = {
        case2: {
            name: '2-bus Simple Example',
            baseMVA: 100,
            bus: [
                [1, 3, 0, 0, 0, 0, 1, 1.0, 0, 230, 1, 1.1, 0.9],
                [2, 1, 100, 35, 0, 0, 1, 1.0, 0, 230, 1, 1.1, 0.9]
            ],
            gen: [
                [1, 0, 0, 150, -150, 1.0, 100, 1, 200, 0]
            ],
            branch: [
                [1, 2, 0.01, 0.1, 0.02, 250, 250, 250, 0, 0, 1]
            ]
        },

        case5: {
            name: '5-bus Example System',
            baseMVA: 100,
            bus: [
                [1, 3, 0, 0, 0, 0, 1, 1.06, 0, 230, 1, 1.1, 0.9],
                [2, 2, 20, 10, 0, 0, 1, 1.0, 0, 230, 1, 1.1, 0.9],
                [3, 1, 45, 15, 0, 0, 1, 1.0, 0, 230, 1, 1.1, 0.9],
                [4, 1, 40, 5, 0, 0, 1, 1.0, 0, 230, 1, 1.1, 0.9],
                [5, 1, 60, 10, 0, 0, 1, 1.0, 0, 230, 1, 1.1, 0.9]
            ],
            gen: [
                [1, 0, 0, 200, -200, 1.06, 100, 1, 250, 10],
                [2, 40, 0, 100, -100, 1.045, 100, 1, 150, 10]
            ],
            branch: [
                [1, 2, 0.02, 0.06, 0.03, 130, 130, 130, 0, 0, 1],
                [1, 3, 0.08, 0.24, 0.025, 130, 130, 130, 0, 0, 1],
                [2, 3, 0.06, 0.18, 0.02, 65, 65, 65, 0, 0, 1],
                [2, 4, 0.06, 0.18, 0.02, 90, 90, 90, 0, 0, 1],
                [2, 5, 0.04, 0.12, 0.015, 70, 70, 70, 0, 0, 1],
                [3, 4, 0.01, 0.03, 0.01, 130, 130, 130, 0, 0, 1],
                [4, 5, 0.08, 0.24, 0.025, 90, 90, 90, 0, 0, 1]
            ]
        },

        case9: {
            name: 'IEEE 9-bus (WSCC)',
            baseMVA: 100,
            bus: [
                [1, 3, 0, 0, 0, 0, 1, 1.04, 0, 16.5, 1, 1.1, 0.9],
                [2, 2, 0, 0, 0, 0, 1, 1.025, 0, 18, 1, 1.1, 0.9],
                [3, 2, 0, 0, 0, 0, 1, 1.025, 0, 13.8, 1, 1.1, 0.9],
                [4, 1, 0, 0, 0, 0, 1, 1, 0, 230, 1, 1.1, 0.9],
                [5, 1, 125, 50, 0, 0, 1, 1, 0, 230, 1, 1.1, 0.9],
                [6, 1, 90, 30, 0, 0, 1, 1, 0, 230, 1, 1.1, 0.9],
                [7, 1, 0, 0, 0, 0, 1, 1, 0, 230, 1, 1.1, 0.9],
                [8, 1, 100, 35, 0, 0, 1, 1, 0, 230, 1, 1.1, 0.9],
                [9, 1, 0, 0, 0, 0, 1, 1, 0, 230, 1, 1.1, 0.9]
            ],
            gen: [
                [1, 71.64, 27.05, 300, -300, 1.04, 100, 1, 250, 10],
                [2, 163, 6.65, 300, -300, 1.025, 100, 1, 300, 10],
                [3, 85, -10.86, 300, -300, 1.025, 100, 1, 270, 10]
            ],
            branch: [
                [1, 4, 0.0001, 0.0576, 0, 250, 250, 250, 0, 0, 1],
                [4, 5, 0.017, 0.092, 0.158, 250, 250, 250, 0, 0, 1],
                [5, 6, 0.039, 0.17, 0.358, 150, 150, 150, 0, 0, 1],
                [3, 6, 0.0001, 0.0586, 0, 300, 300, 300, 0, 0, 1],
                [6, 7, 0.0119, 0.1008, 0.209, 150, 150, 150, 0, 0, 1],
                [7, 8, 0.0085, 0.072, 0.149, 250, 250, 250, 0, 0, 1],
                [8, 2, 0.0001, 0.0625, 0, 250, 250, 250, 0, 0, 1],
                [8, 9, 0.032, 0.161, 0.306, 250, 250, 250, 0, 0, 1],
                [9, 4, 0.01, 0.085, 0.176, 250, 250, 250, 0, 0, 1]
            ]
        },

        case14: {
            name: 'IEEE 14-bus',
            baseMVA: 100,
            bus: [
                [1, 3, 0, 0, 0, 0, 1, 1.06, 0, 0, 1, 1.06, 0.94],
                [2, 2, 21.7, 12.7, 0, 0, 1, 1.045, 0, 0, 1, 1.06, 0.94],
                [3, 2, 94.2, 19, 0, 0, 1, 1.01, 0, 0, 1, 1.06, 0.94],
                [4, 1, 47.8, -3.9, 0, 0, 1, 1, 0, 0, 1, 1.06, 0.94],
                [5, 1, 7.6, 1.6, 0, 0, 1, 1, 0, 0, 1, 1.06, 0.94],
                [6, 2, 11.2, 7.5, 0, 0, 1, 1.07, 0, 0, 1, 1.06, 0.94],
                [7, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1.06, 0.94],
                [8, 2, 0, 0, 0, 0, 1, 1.09, 0, 0, 1, 1.06, 0.94],
                [9, 1, 29.5, 16.6, 0, 19, 1, 1, 0, 0, 1, 1.06, 0.94],
                [10, 1, 9, 5.8, 0, 0, 1, 1, 0, 0, 1, 1.06, 0.94],
                [11, 1, 3.5, 1.8, 0, 0, 1, 1, 0, 0, 1, 1.06, 0.94],
                [12, 1, 6.1, 1.6, 0, 0, 1, 1, 0, 0, 1, 1.06, 0.94],
                [13, 1, 13.5, 5.8, 0, 0, 1, 1, 0, 0, 1, 1.06, 0.94],
                [14, 1, 14.9, 5, 0, 0, 1, 1, 0, 0, 1, 1.06, 0.94]
            ],
            gen: [
                [1, 232.4, -16.9, 10, 0, 1.06, 100, 1, 332.4, 0],
                [2, 40, 42.4, 50, -40, 1.045, 100, 1, 140, 0],
                [3, 0, 23.4, 40, 0, 1.01, 100, 1, 100, 0],
                [6, 0, 12.2, 24, -6, 1.07, 100, 1, 100, 0],
                [8, 0, 17.4, 24, -6, 1.09, 100, 1, 100, 0]
            ],
            branch: [
                [1, 2, 0.01938, 0.05917, 0.0528, 472, 472, 472, 0, 0, 1],
                [1, 5, 0.05403, 0.22304, 0.0492, 128, 128, 128, 0, 0, 1],
                [2, 3, 0.04699, 0.19797, 0.0438, 145, 145, 145, 0, 0, 1],
                [2, 4, 0.05811, 0.17632, 0.034, 132, 132, 132, 0, 0, 1],
                [2, 5, 0.05695, 0.17388, 0.0346, 136, 136, 136, 0, 0, 1],
                [3, 4, 0.06701, 0.17103, 0.0128, 65, 65, 65, 0, 0, 1],
                [4, 5, 0.01335, 0.04211, 0, 0, 0, 0, 0, 0, 1],
                [4, 7, 0.0001, 0.20912, 0, 0, 0, 0, 0.978, 0, 1],
                [4, 9, 0.0001, 0.55618, 0, 0, 0, 0, 0.969, 0, 1],
                [5, 6, 0.0001, 0.25202, 0, 0, 0, 0, 0.932, 0, 1],
                [6, 11, 0.09498, 0.1989, 0, 0, 0, 0, 0, 0, 1],
                [6, 12, 0.12291, 0.25581, 0, 0, 0, 0, 0, 0, 1],
                [6, 13, 0.06615, 0.13027, 0, 0, 0, 0, 0, 0, 1],
                [7, 8, 0.0001, 0.17615, 0, 0, 0, 0, 0, 0, 1],
                [7, 9, 0.11001, 0.2064, 0, 0, 0, 0, 0, 0, 1],
                [9, 10, 0.03181, 0.0845, 0, 0, 0, 0, 0, 0, 1],
                [9, 14, 0.12711, 0.27038, 0, 0, 0, 0, 0, 0, 1],
                [10, 11, 0.08205, 0.19207, 0, 0, 0, 0, 0, 0, 1],
                [12, 13, 0.22092, 0.19988, 0, 0, 0, 0, 0, 0, 1],
                [13, 14, 0.17093, 0.34802, 0, 0, 0, 0, 0, 0, 1]
            ]
        },

        case30: {
            name: 'IEEE 30-bus',
            baseMVA: 100,
            bus: [
                [1, 3, 0, 0, 0, 0, 1, 1.06, 0, 132, 1, 1.05, 0.95],
                [2, 2, 21.7, 12.7, 0, 0, 1, 1.043, 0, 132, 1, 1.1, 0.95],
                [3, 1, 2.4, 1.2, 0, 0, 1, 1, 0, 132, 1, 1.05, 0.95],
                [4, 1, 7.6, 1.6, 0, 0, 1, 1, 0, 132, 1, 1.05, 0.95],
                [5, 2, 94.2, 19, 0, 0, 1, 1.01, 0, 132, 1, 1.1, 0.95],
                [6, 1, 0, 0, 0, 0, 1, 1, 0, 132, 1, 1.05, 0.95],
                [7, 1, 22.8, 10.9, 0, 0, 1, 1, 0, 132, 1, 1.05, 0.95],
                [8, 2, 30, 30, 0, 0, 1, 1.01, 0, 132, 1, 1.1, 0.95],
                [9, 1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1.05, 0.95],
                [10, 1, 5.8, 2, 0, 19, 1, 1, 0, 33, 1, 1.05, 0.95],
                [11, 2, 0, 0, 0, 0, 1, 1.082, 0, 11, 1, 1.1, 0.95],
                [12, 1, 11.2, 7.5, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [13, 2, 0, 0, 0, 0, 1, 1.071, 0, 11, 1, 1.1, 0.95],
                [14, 1, 6.2, 1.6, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [15, 1, 8.2, 2.5, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [16, 1, 3.5, 1.8, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [17, 1, 9, 5.8, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [18, 1, 3.2, 0.9, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [19, 1, 9.5, 3.4, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [20, 1, 2.2, 0.7, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [21, 1, 17.5, 11.2, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [22, 1, 0, 0, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [23, 1, 3.2, 1.6, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [24, 1, 8.7, 6.7, 0, 4.3, 1, 1, 0, 33, 1, 1.05, 0.95],
                [25, 1, 0, 0, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [26, 1, 3.5, 2.3, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [27, 1, 0, 0, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [28, 1, 0, 0, 0, 0, 1, 1, 0, 132, 1, 1.05, 0.95],
                [29, 1, 2.4, 0.9, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95],
                [30, 1, 10.6, 1.9, 0, 0, 1, 1, 0, 33, 1, 1.05, 0.95]
            ],
            gen: [
                [1, 260.2, -16.1, 10, -20, 1.06, 100, 1, 360.2, 0],
                [2, 40, 50, 50, -20, 1.043, 100, 1, 140, 0],
                [5, 0, 37, 40, -15, 1.01, 100, 1, 100, 0],
                [8, 0, 37.3, 40, -15, 1.01, 100, 1, 100, 0],
                [11, 0, 16.2, 24, -10, 1.082, 100, 1, 100, 0],
                [13, 0, 10.6, 24, -10, 1.071, 100, 1, 100, 0]
            ],
            branch: [
                [1, 2, 0.0192, 0.0575, 0.0528, 130, 130, 130, 0, 0, 1],
                [1, 3, 0.0452, 0.1852, 0.0408, 130, 130, 130, 0, 0, 1],
                [2, 4, 0.057, 0.1737, 0.0368, 65, 65, 65, 0, 0, 1],
                [3, 4, 0.0132, 0.0379, 0.0084, 130, 130, 130, 0, 0, 1],
                [2, 5, 0.0472, 0.1983, 0.0418, 130, 130, 130, 0, 0, 1],
                [2, 6, 0.0581, 0.1763, 0.0374, 65, 65, 65, 0, 0, 1],
                [4, 6, 0.0119, 0.0414, 0.009, 90, 90, 90, 0, 0, 1],
                [5, 7, 0.046, 0.116, 0.0204, 70, 70, 70, 0, 0, 1],
                [6, 7, 0.0267, 0.082, 0.017, 130, 130, 130, 0, 0, 1],
                [6, 8, 0.012, 0.042, 0.009, 32, 32, 32, 0, 0, 1],
                [6, 9, 0.0001, 0.208, 0, 65, 65, 65, 0.978, 0, 1],
                [6, 10, 0.0001, 0.556, 0, 32, 32, 32, 0.969, 0, 1],
                [9, 11, 0.0001, 0.208, 0, 65, 65, 65, 0, 0, 1],
                [9, 10, 0.0001, 0.11, 0, 65, 65, 65, 0, 0, 1],
                [4, 12, 0.0001, 0.256, 0, 65, 65, 65, 0.932, 0, 1],
                [12, 13, 0.0001, 0.14, 0, 65, 65, 65, 0, 0, 1],
                [12, 14, 0.1231, 0.2559, 0, 32, 32, 32, 0, 0, 1],
                [12, 15, 0.0662, 0.1304, 0, 32, 32, 32, 0, 0, 1],
                [12, 16, 0.0945, 0.1987, 0, 32, 32, 32, 0, 0, 1],
                [14, 15, 0.221, 0.1997, 0, 16, 16, 16, 0, 0, 1],
                [16, 17, 0.0524, 0.1923, 0, 16, 16, 16, 0, 0, 1],
                [15, 18, 0.1073, 0.2185, 0, 16, 16, 16, 0, 0, 1],
                [18, 19, 0.0639, 0.1292, 0, 16, 16, 16, 0, 0, 1],
                [19, 20, 0.034, 0.068, 0, 32, 32, 32, 0, 0, 1],
                [10, 20, 0.0936, 0.209, 0, 32, 32, 32, 0, 0, 1],
                [10, 17, 0.0324, 0.0845, 0, 32, 32, 32, 0, 0, 1],
                [10, 21, 0.0348, 0.0749, 0, 32, 32, 32, 0, 0, 1],
                [10, 22, 0.0727, 0.1499, 0, 32, 32, 32, 0, 0, 1],
                [21, 22, 0.0116, 0.0236, 0, 32, 32, 32, 0, 0, 1],
                [15, 23, 0.1, 0.202, 0, 16, 16, 16, 0, 0, 1],
                [22, 24, 0.115, 0.179, 0, 16, 16, 16, 0, 0, 1],
                [23, 24, 0.132, 0.27, 0, 16, 16, 16, 0, 0, 1],
                [24, 25, 0.1885, 0.3292, 0, 16, 16, 16, 0, 0, 1],
                [25, 26, 0.2544, 0.38, 0, 16, 16, 16, 0, 0, 1],
                [25, 27, 0.1093, 0.2087, 0, 16, 16, 16, 0, 0, 1],
                [28, 27, 0.0001, 0.396, 0, 65, 65, 65, 0.968, 0, 1],
                [27, 29, 0.2198, 0.4153, 0, 16, 16, 16, 0, 0, 1],
                [27, 30, 0.3202, 0.6027, 0, 16, 16, 16, 0, 0, 1],
                [29, 30, 0.2399, 0.4533, 0, 16, 16, 16, 0, 0, 1],
                [8, 28, 0.0636, 0.2, 0.0428, 32, 32, 32, 0, 0, 1],
                [6, 28, 0.0169, 0.0599, 0.013, 32, 32, 32, 0, 0, 1]
            ]
        }
    };

    // ============================================================
    // Power Flow Engine
    // ============================================================
    class PowerFlowEngine {
        constructor(caseData) {
            this.baseMVA = caseData.baseMVA;
            this.busData = JSON.parse(JSON.stringify(caseData.bus));
            this.genData = JSON.parse(JSON.stringify(caseData.gen));
            this.branchData = JSON.parse(JSON.stringify(caseData.branch));
            
            this.nBus = this.busData.length;
            this.nBranch = this.branchData.length;
            
            this.V = [];
            this.delta = [];
            this.Pgen = [];
            this.Qgen = [];
            
            this.slackBus = -1;
            this.pvBuses = [];
            this.pqBuses = [];
            
            this.Ybus = { re: [], im: [] };
            
            this.iteration = 0;
            this.converged = false;
            this.errorHistory = [];
            this.maxPError = 0;
            this.maxQError = 0;
            
            this.initialize();
        }

        initialize() {
            for (let i = 0; i < this.nBus; i++) {
                const bus = this.busData[i];
                this.V[i] = bus[7];
                this.delta[i] = bus[8] * Math.PI / 180;
                
                if (bus[1] === 3) {
                    this.slackBus = i;
                } else if (bus[1] === 2) {
                    this.pvBuses.push(i);
                } else {
                    this.pqBuses.push(i);
                }
            }

            this.Pgen = new Array(this.nBus).fill(0);
            this.Qgen = new Array(this.nBus).fill(0);
            
            for (const gen of this.genData) {
                const busIdx = gen[0] - 1;
                this.Pgen[busIdx] += gen[1] / this.baseMVA;
                this.Qgen[busIdx] += gen[2] / this.baseMVA;
                
                if (this.pvBuses.includes(busIdx) || busIdx === this.slackBus) {
                    this.V[busIdx] = gen[5];
                }
            }

            this.buildYbus();
            
            this.iteration = 0;
            this.converged = false;
            this.errorHistory = [];
        }

        buildYbus() {
            for (let i = 0; i < this.nBus; i++) {
                this.Ybus.re[i] = new Array(this.nBus).fill(0);
                this.Ybus.im[i] = new Array(this.nBus).fill(0);
            }

            for (const branch of this.branchData) {
                const from = branch[0] - 1;
                const to = branch[1] - 1;
                let r = branch[2];
                let x = branch[3];
                const b = branch[4];
                const tap = branch[8] || 1;
                
                // Handle zero impedance (transformers)
                if (Math.abs(r) < 1e-8 && Math.abs(x) < 1e-8) continue;
                if (Math.abs(r) < 1e-8) r = 1e-6;
                if (Math.abs(x) < 1e-8) x = 1e-6;
                
                const z2 = r * r + x * x;
                const g = r / z2;
                const bSeries = -x / z2;
                
                const tapRatio = tap === 0 ? 1 : tap;
                
                this.Ybus.re[from][to] -= g / tapRatio;
                this.Ybus.im[from][to] -= bSeries / tapRatio;
                this.Ybus.re[to][from] -= g / tapRatio;
                this.Ybus.im[to][from] -= bSeries / tapRatio;
                
                this.Ybus.re[from][from] += g / (tapRatio * tapRatio);
                this.Ybus.im[from][from] += bSeries / (tapRatio * tapRatio) + b / 2;
                this.Ybus.re[to][to] += g;
                this.Ybus.im[to][to] += bSeries + b / 2;
            }

            for (let i = 0; i < this.nBus; i++) {
                const Gs = this.busData[i][4] / this.baseMVA;
                const Bs = this.busData[i][5] / this.baseMVA;
                this.Ybus.re[i][i] += Gs;
                this.Ybus.im[i][i] += Bs;
            }
        }

        calcPowerInjection() {
            const P = new Array(this.nBus).fill(0);
            const Q = new Array(this.nBus).fill(0);

            for (let i = 0; i < this.nBus; i++) {
                for (let j = 0; j < this.nBus; j++) {
                    const Gij = this.Ybus.re[i][j];
                    const Bij = this.Ybus.im[i][j];
                    const thetaij = this.delta[i] - this.delta[j];
                    
                    P[i] += this.V[i] * this.V[j] * (Gij * Math.cos(thetaij) + Bij * Math.sin(thetaij));
                    Q[i] += this.V[i] * this.V[j] * (Gij * Math.sin(thetaij) - Bij * Math.cos(thetaij));
                }
            }

            return { P, Q };
        }

        calcMismatch() {
            const { P, Q } = this.calcPowerInjection();
            const deltaP = [];
            const deltaQ = [];

            for (let i = 0; i < this.nBus; i++) {
                if (i === this.slackBus) continue;
                
                const Pload = this.busData[i][2] / this.baseMVA;
                const Qload = this.busData[i][3] / this.baseMVA;
                const Pspec = this.Pgen[i] - Pload;
                const Qspec = this.Qgen[i] - Qload;
                
                deltaP.push({ bus: i, value: Pspec - P[i] });
                
                if (this.pqBuses.includes(i)) {
                    deltaQ.push({ bus: i, value: Qspec - Q[i] });
                }
            }

            return { deltaP, deltaQ, Pcalc: P, Qcalc: Q };
        }

        newtonRaphsonStep() {
            const { deltaP, deltaQ } = this.calcMismatch();
            
            const f = [...deltaP.map(d => d.value), ...deltaQ.map(d => d.value)];
            const n = f.length;
            
            if (n === 0) return { maxError: 0 };
            
            const J = this.buildJacobian(deltaP, deltaQ);
            const dx = this.solveLU(J, f);
            
            if (!dx || dx.some(v => !isFinite(v))) {
                return { maxError: Infinity };
            }
            
            let idx = 0;
            for (const dp of deltaP) {
                this.delta[dp.bus] += dx[idx++];
            }
            for (const dq of deltaQ) {
                this.V[dq.bus] += dx[idx++];
                this.V[dq.bus] = Math.max(0.5, Math.min(1.5, this.V[dq.bus]));
            }
            
            this.maxPError = deltaP.length > 0 ? Math.max(...deltaP.map(d => Math.abs(d.value))) : 0;
            this.maxQError = deltaQ.length > 0 ? Math.max(...deltaQ.map(d => Math.abs(d.value))) : 0;
            
            return { 
                maxError: Math.max(this.maxPError, this.maxQError),
                deltaP,
                deltaQ
            };
        }

        buildJacobian(deltaP, deltaQ) {
            const nP = deltaP.length;
            const nQ = deltaQ.length;
            const n = nP + nQ;
            
            const J = Array(n).fill(null).map(() => Array(n).fill(0));
            
            for (let i = 0; i < nP; i++) {
                const bi = deltaP[i].bus;
                for (let j = 0; j < nP; j++) {
                    const bj = deltaP[j].bus;
                    J[i][j] = this.dPdDelta(bi, bj);
                }
            }
            
            for (let i = 0; i < nP; i++) {
                const bi = deltaP[i].bus;
                for (let j = 0; j < nQ; j++) {
                    const bj = deltaQ[j].bus;
                    J[i][nP + j] = this.dPdV(bi, bj);
                }
            }
            
            for (let i = 0; i < nQ; i++) {
                const bi = deltaQ[i].bus;
                for (let j = 0; j < nP; j++) {
                    const bj = deltaP[j].bus;
                    J[nP + i][j] = this.dQdDelta(bi, bj);
                }
            }
            
            for (let i = 0; i < nQ; i++) {
                const bi = deltaQ[i].bus;
                for (let j = 0; j < nQ; j++) {
                    const bj = deltaQ[j].bus;
                    J[nP + i][nP + j] = this.dQdV(bi, bj);
                }
            }
            
            return J;
        }

        dPdDelta(i, j) {
            if (i === j) {
                let sum = 0;
                for (let k = 0; k < this.nBus; k++) {
                    if (k === i) continue;
                    const Gik = this.Ybus.re[i][k];
                    const Bik = this.Ybus.im[i][k];
                    const thetaik = this.delta[i] - this.delta[k];
                    sum += this.V[i] * this.V[k] * (-Gik * Math.sin(thetaik) + Bik * Math.cos(thetaik));
                }
                return sum;
            } else {
                const Gij = this.Ybus.re[i][j];
                const Bij = this.Ybus.im[i][j];
                const thetaij = this.delta[i] - this.delta[j];
                return this.V[i] * this.V[j] * (Gij * Math.sin(thetaij) - Bij * Math.cos(thetaij));
            }
        }

        dPdV(i, j) {
            if (i === j) {
                let sum = 2 * this.V[i] * this.Ybus.re[i][i];
                for (let k = 0; k < this.nBus; k++) {
                    if (k === i) continue;
                    const Gik = this.Ybus.re[i][k];
                    const Bik = this.Ybus.im[i][k];
                    const thetaik = this.delta[i] - this.delta[k];
                    sum += this.V[k] * (Gik * Math.cos(thetaik) + Bik * Math.sin(thetaik));
                }
                return sum;
            } else {
                const Gij = this.Ybus.re[i][j];
                const Bij = this.Ybus.im[i][j];
                const thetaij = this.delta[i] - this.delta[j];
                return this.V[i] * (Gij * Math.cos(thetaij) + Bij * Math.sin(thetaij));
            }
        }

        dQdDelta(i, j) {
            if (i === j) {
                let sum = 0;
                for (let k = 0; k < this.nBus; k++) {
                    if (k === i) continue;
                    const Gik = this.Ybus.re[i][k];
                    const Bik = this.Ybus.im[i][k];
                    const thetaik = this.delta[i] - this.delta[k];
                    sum += this.V[i] * this.V[k] * (Gik * Math.cos(thetaik) + Bik * Math.sin(thetaik));
                }
                return sum;
            } else {
                const Gij = this.Ybus.re[i][j];
                const Bij = this.Ybus.im[i][j];
                const thetaij = this.delta[i] - this.delta[j];
                return -this.V[i] * this.V[j] * (Gij * Math.cos(thetaij) + Bij * Math.sin(thetaij));
            }
        }

        dQdV(i, j) {
            if (i === j) {
                let sum = -2 * this.V[i] * this.Ybus.im[i][i];
                for (let k = 0; k < this.nBus; k++) {
                    if (k === i) continue;
                    const Gik = this.Ybus.re[i][k];
                    const Bik = this.Ybus.im[i][k];
                    const thetaik = this.delta[i] - this.delta[k];
                    sum += this.V[k] * (Gik * Math.sin(thetaik) - Bik * Math.cos(thetaik));
                }
                return sum;
            } else {
                const Gij = this.Ybus.re[i][j];
                const Bij = this.Ybus.im[i][j];
                const thetaij = this.delta[i] - this.delta[j];
                return this.V[i] * (Gij * Math.sin(thetaij) - Bij * Math.cos(thetaij));
            }
        }

        gaussSeidelStep() {
            for (let i = 0; i < this.nBus; i++) {
                if (i === this.slackBus) continue;
                
                const Pload = this.busData[i][2] / this.baseMVA;
                const Qload = this.busData[i][3] / this.baseMVA;
                const Pspec = this.Pgen[i] - Pload;
                const Qspec = this.pqBuses.includes(i) ? (this.Qgen[i] - Qload) : 0;
                
                let sumYV_re = 0, sumYV_im = 0;
                for (let j = 0; j < this.nBus; j++) {
                    if (j === i) continue;
                    const Vj_re = this.V[j] * Math.cos(this.delta[j]);
                    const Vj_im = this.V[j] * Math.sin(this.delta[j]);
                    sumYV_re += this.Ybus.re[i][j] * Vj_re - this.Ybus.im[i][j] * Vj_im;
                    sumYV_im += this.Ybus.re[i][j] * Vj_im + this.Ybus.im[i][j] * Vj_re;
                }
                
                const Vi_re = this.V[i] * Math.cos(this.delta[i]);
                const Vi_im = this.V[i] * Math.sin(this.delta[i]);
                const Vmag2 = this.V[i] * this.V[i];
                const SoverVconj_re = (Pspec * Vi_re + Qspec * Vi_im) / Vmag2;
                const SoverVconj_im = (Pspec * Vi_im - Qspec * Vi_re) / Vmag2;
                
                const Yii_mag2 = this.Ybus.re[i][i] ** 2 + this.Ybus.im[i][i] ** 2;
                if (Yii_mag2 < 1e-12) continue;
                
                const rhs_re = SoverVconj_re - sumYV_re;
                const rhs_im = SoverVconj_im - sumYV_im;
                
                const newV_re = (rhs_re * this.Ybus.re[i][i] + rhs_im * this.Ybus.im[i][i]) / Yii_mag2;
                const newV_im = (rhs_im * this.Ybus.re[i][i] - rhs_re * this.Ybus.im[i][i]) / Yii_mag2;
                
                const newVmag = Math.sqrt(newV_re * newV_re + newV_im * newV_im);
                const newVang = Math.atan2(newV_im, newV_re);
                
                const alpha = 1.0;
                this.delta[i] = this.delta[i] + alpha * (newVang - this.delta[i]);
                if (this.pqBuses.includes(i)) {
                    this.V[i] = this.V[i] + alpha * (newVmag - this.V[i]);
                    this.V[i] = Math.max(0.5, Math.min(1.5, this.V[i]));
                }
            }
            
            const { deltaP, deltaQ } = this.calcMismatch();
            this.maxPError = deltaP.length > 0 ? Math.max(...deltaP.map(d => Math.abs(d.value))) : 0;
            this.maxQError = deltaQ.length > 0 ? Math.max(...deltaQ.map(d => Math.abs(d.value))) : 0;
            
            return { 
                maxError: Math.max(this.maxPError, this.maxQError),
                deltaP,
                deltaQ
            };
        }

        fastDecoupledStep() {
            const { deltaP, deltaQ } = this.calcMismatch();
            
            if (deltaP.length > 0) {
                const Bp = this.buildBMatrix(deltaP.map(d => d.bus));
                const fp = deltaP.map(d => d.value / this.V[d.bus]);
                const dDelta = this.solveLU(Bp, fp);
                
                if (dDelta && dDelta.every(v => isFinite(v))) {
                    for (let i = 0; i < deltaP.length; i++) {
                        this.delta[deltaP[i].bus] += dDelta[i];
                    }
                }
            }
            
            if (deltaQ.length > 0) {
                const Bpp = this.buildBMatrix(deltaQ.map(d => d.bus));
                const fq = deltaQ.map(d => d.value / this.V[d.bus]);
                const dV = this.solveLU(Bpp, fq);
                
                if (dV && dV.every(v => isFinite(v))) {
                    for (let i = 0; i < deltaQ.length; i++) {
                        this.V[deltaQ[i].bus] += dV[i];
                        this.V[deltaQ[i].bus] = Math.max(0.5, Math.min(1.5, this.V[deltaQ[i].bus]));
                    }
                }
            }
            
            const newMismatch = this.calcMismatch();
            this.maxPError = newMismatch.deltaP.length > 0 ? Math.max(...newMismatch.deltaP.map(d => Math.abs(d.value))) : 0;
            this.maxQError = newMismatch.deltaQ.length > 0 ? Math.max(...newMismatch.deltaQ.map(d => Math.abs(d.value))) : 0;
            
            return { 
                maxError: Math.max(this.maxPError, this.maxQError),
                deltaP: newMismatch.deltaP,
                deltaQ: newMismatch.deltaQ
            };
        }

        buildBMatrix(buses) {
            const n = buses.length;
            const B = Array(n).fill(null).map(() => Array(n).fill(0));
            
            for (let i = 0; i < n; i++) {
                for (let j = 0; j < n; j++) {
                    B[i][j] = -this.Ybus.im[buses[i]][buses[j]];
                }
            }
            
            return B;
        }

        solveLU(A, b) {
            const n = A.length;
            if (n === 0) return [];
            
            try {
                const LU = A.map(row => [...row]);
                const P = Array.from({ length: n }, (_, i) => i);
                
                for (let k = 0; k < n; k++) {
                    let maxVal = Math.abs(LU[k][k]);
                    let maxIdx = k;
                    for (let i = k + 1; i < n; i++) {
                        if (Math.abs(LU[i][k]) > maxVal) {
                            maxVal = Math.abs(LU[i][k]);
                            maxIdx = i;
                        }
                    }
                    
                    if (maxIdx !== k) {
                        [LU[k], LU[maxIdx]] = [LU[maxIdx], LU[k]];
                        [P[k], P[maxIdx]] = [P[maxIdx], P[k]];
                    }
                    
                    if (Math.abs(LU[k][k]) < 1e-12) {
                        LU[k][k] = 1e-10;
                    }
                    
                    for (let i = k + 1; i < n; i++) {
                        LU[i][k] /= LU[k][k];
                        for (let j = k + 1; j < n; j++) {
                            LU[i][j] -= LU[i][k] * LU[k][j];
                        }
                    }
                }
                
                const y = new Array(n).fill(0);
                for (let i = 0; i < n; i++) {
                    y[i] = b[P[i]];
                    for (let j = 0; j < i; j++) {
                        y[i] -= LU[i][j] * y[j];
                    }
                }
                
                const x = new Array(n).fill(0);
                for (let i = n - 1; i >= 0; i--) {
                    x[i] = y[i];
                    for (let j = i + 1; j < n; j++) {
                        x[i] -= LU[i][j] * x[j];
                    }
                    x[i] /= LU[i][i];
                }
                
                return x;
            } catch (e) {
                console.error('LU solve error:', e);
                return new Array(n).fill(0);
            }
        }

        runIteration(algorithm) {
            this.iteration++;
            
            let result;
            switch (algorithm) {
                case 'nr':
                    result = this.newtonRaphsonStep();
                    break;
                case 'fdxb':
                    result = this.fastDecoupledStep();
                    break;
                case 'gs':
                    result = this.gaussSeidelStep();
                    break;
                default:
                    result = this.newtonRaphsonStep();
            }
            
            this.errorHistory.push({
                iteration: this.iteration,
                maxP: this.maxPError,
                maxQ: this.maxQError,
                max: result.maxError
            });
            
            return result;
        }

        getBusResults() {
            const { P, Q } = this.calcPowerInjection();
            
            return this.busData.map((bus, i) => {
                const Pload = bus[2] / this.baseMVA;
                const Qload = bus[3] / this.baseMVA;
                const Pspec = this.Pgen[i] - Pload;
                const Qspec = this.Qgen[i] - Qload;
                
                return {
                    bus: bus[0],
                    type: bus[1] === 3 ? 'Slack' : (bus[1] === 2 ? 'PV' : 'PQ'),
                    V: this.V[i],
                    delta: this.delta[i] * 180 / Math.PI,
                    Pgen: this.Pgen[i] * this.baseMVA,
                    Qgen: this.Qgen[i] * this.baseMVA,
                    Pload: bus[2],
                    Qload: bus[3],
                    deltaP: i === this.slackBus ? 0 : Pspec - P[i],
                    deltaQ: i === this.slackBus || this.pvBuses.includes(i) ? 0 : Qspec - Q[i]
                };
            });
        }
    }

    // ============================================================
    // Application
    // ============================================================
    let engine = null;
    let running = false;

    function init() {
        document.getElementById('caseSelect').addEventListener('change', loadCase);
        document.getElementById('runBtn').addEventListener('click', run);
        document.getElementById('stepBtn').addEventListener('click', step);
        document.getElementById('resetBtn').addEventListener('click', reset);
        
        loadCase();
    }

    function loadCase() {
        const caseName = document.getElementById('caseSelect').value;
        const caseData = MATPOWER_CASES[caseName];
        
        if (!caseData) {
            console.error('Case not found:', caseName);
            return;
        }
        
        try {
            engine = new PowerFlowEngine(caseData);
            
            document.getElementById('busCount').textContent = engine.nBus;
            document.getElementById('branchCount').textContent = engine.nBranch;
            document.getElementById('genCount').textContent = engine.genData.length;
            document.getElementById('statusValue').textContent = 'ÂæÖÊ©ü‰∏≠';
            document.getElementById('statusCard').className = 'stat-card';
            
            updateDisplay();
            drawAll();
        } catch (e) {
            console.error('Error loading case:', e);
        }
    }

    function reset() {
        running = false;
        loadCase();
    }

    async function run() {
        if (running) return;
        running = true;
        
        const tolerance = parseFloat(document.getElementById('tolSelect').value);
        const maxIter = parseInt(document.getElementById('maxIterInput').value);
        const speed = parseFloat(document.getElementById('speedSelect').value);
        const algorithm = document.getElementById('algoSelect').value;
        
        document.getElementById('runBtn').disabled = true;
        document.getElementById('statusValue').textContent = 'ÂÆüË°å‰∏≠...';
        document.getElementById('statusCard').className = 'stat-card warning';
        
        while (running && engine.iteration < maxIter) {
            const result = engine.runIteration(algorithm);
            
            updateDisplay();
            drawAll();
            updateEquation(algorithm, result);
            
            if (result.maxError < tolerance) {
                engine.converged = true;
                document.getElementById('statusValue').textContent = 'ÂèéÊùü!';
                document.getElementById('statusCard').className = 'stat-card success';
                break;
            }
            
            if (!isFinite(result.maxError)) {
                document.getElementById('statusValue').textContent = 'Áô∫Êï£';
                document.getElementById('statusCard').className = 'stat-card error';
                break;
            }
            
            if (speed > 0) {
                await new Promise(r => setTimeout(r, 500 / speed));
            }
        }
        
        if (!engine.converged && engine.iteration >= maxIter) {
            document.getElementById('statusValue').textContent = 'Êú™ÂèéÊùü';
            document.getElementById('statusCard').className = 'stat-card error';
        }
        
        running = false;
        document.getElementById('runBtn').disabled = false;
    }

    async function step() {
        if (running) return;
        
        const algorithm = document.getElementById('algoSelect').value;
        const result = engine.runIteration(algorithm);
        
        updateDisplay();
        drawAll();
        updateEquation(algorithm, result);
        
        const tolerance = parseFloat(document.getElementById('tolSelect').value);
        if (result.maxError < tolerance) {
            engine.converged = true;
            document.getElementById('statusValue').textContent = 'ÂèéÊùü!';
            document.getElementById('statusCard').className = 'stat-card success';
        }
    }

    function updateDisplay() {
        document.getElementById('iterValue').textContent = engine.iteration;
        
        const maxError = Math.max(engine.maxPError, engine.maxQError);
        document.getElementById('errorValue').textContent = maxError > 0 ? maxError.toExponential(2) : '-';
        
        updateBusTable();
    }

    function updateBusTable() {
        const tbody = document.getElementById('busTableBody');
        tbody.innerHTML = '';
        
        const results = engine.getBusResults();
        
        results.forEach(bus => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${bus.bus}</td>
                <td><span class="bus-type ${bus.type.toLowerCase()}">${bus.type}</span></td>
                <td>${bus.V.toFixed(4)}</td>
                <td>${bus.delta.toFixed(2)}</td>
                <td>${bus.Pgen.toFixed(2)}</td>
                <td>${bus.Qgen.toFixed(2)}</td>
                <td>${bus.Pload.toFixed(2)}</td>
                <td>${bus.Qload.toFixed(2)}</td>
                <td style="color: ${Math.abs(bus.deltaP) > 0.01 ? 'var(--error)' : 'var(--success)'}">${bus.deltaP.toFixed(6)}</td>
                <td style="color: ${Math.abs(bus.deltaQ) > 0.01 ? 'var(--error)' : 'var(--success)'}">${bus.deltaQ.toFixed(6)}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function updateEquation(algorithm, result) {
        const algoNames = {
            'nr': 'Newton-RaphsonÊ≥ï',
            'fdxb': 'Fast Decoupled XBÊ≥ï',
            'gs': 'Gauss-SeidelÊ≥ï'
        };
        
        let text = `<span class="eq-comment">// ${algoNames[algorithm]} - ÂèçÂæ© ${engine.iteration}</span>\n\n`;
        text += `<span class="eq-var">ŒîP_max</span> = ${engine.maxPError.toExponential(4)} p.u.\n`;
        text += `<span class="eq-var">ŒîQ_max</span> = ${engine.maxQError.toExponential(4)} p.u.\n`;
        
        document.getElementById('equationBox').innerHTML = text;
    }

    function drawAll() {
        drawNetwork();
        drawConvergence();
        drawVoltageProfile();
        drawJacobian();
    }

    function drawNetwork() {
        const canvas = document.getElementById('networkCanvas');
        const ctx = canvas.getContext('2d');
        const rect = canvas.parentElement.getBoundingClientRect();
        
        canvas.width = rect.width - 30;
        canvas.height = rect.height - 30;
        
        const w = canvas.width;
        const h = canvas.height;

        ctx.fillStyle = '#12121a';
        ctx.fillRect(0, 0, w, h);

        if (!engine) return;

        const n = engine.nBus;
        const cx = w / 2;
        const cy = h / 2;
        const radius = Math.min(w, h) * 0.4;
        
        const positions = engine.busData.map((_, i) => ({
            x: cx + radius * Math.cos(2 * Math.PI * i / n - Math.PI / 2),
            y: cy + radius * Math.sin(2 * Math.PI * i / n - Math.PI / 2)
        }));

        // Draw branches
        ctx.strokeStyle = 'rgba(59, 130, 246, 0.4)';
        ctx.lineWidth = 2;
        
        engine.branchData.forEach(branch => {
            const from = positions[branch[0] - 1];
            const to = positions[branch[1] - 1];
            if (from && to) {
                ctx.beginPath();
                ctx.moveTo(from.x, from.y);
                ctx.lineTo(to.x, to.y);
                ctx.stroke();
            }
        });

        // Draw buses
        const results = engine.getBusResults();
        const nodeRadius = n > 20 ? 12 : 18;
        
        results.forEach((bus, i) => {
            const pos = positions[i];
            if (!pos) return;
            
            const maxError = Math.max(Math.abs(bus.deltaP), Math.abs(bus.deltaQ));
            
            if (maxError > 0.01) {
                const glow = ctx.createRadialGradient(pos.x, pos.y, nodeRadius, pos.x, pos.y, nodeRadius * 2);
                glow.addColorStop(0, 'rgba(239, 68, 68, 0.5)');
                glow.addColorStop(1, 'rgba(239, 68, 68, 0)');
                ctx.fillStyle = glow;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, nodeRadius * 2, 0, 2 * Math.PI);
                ctx.fill();
            }

            ctx.beginPath();
            ctx.arc(pos.x, pos.y, nodeRadius, 0, 2 * Math.PI);
            
            if (bus.type === 'Slack') ctx.fillStyle = '#10b981';
            else if (bus.type === 'PV') ctx.fillStyle = '#f59e0b';
            else ctx.fillStyle = '#3b82f6';
            
            ctx.fill();
            ctx.strokeStyle = '#f1f5f9';
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.fillStyle = '#0a0a0f';
            ctx.font = `bold ${nodeRadius * 0.7}px JetBrains Mono`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(bus.bus, pos.x, pos.y);
        });
    }

    function drawConvergence() {
        const canvas = document.getElementById('convergenceCanvas');
        const ctx = canvas.getContext('2d');
        const rect = canvas.parentElement.getBoundingClientRect();
        
        canvas.width = rect.width - 30;
        canvas.height = rect.height - 30;
        
        const w = canvas.width;
        const h = canvas.height;
        const padding = { top: 20, right: 20, bottom: 35, left: 55 };

        ctx.fillStyle = '#12121a';
        ctx.fillRect(0, 0, w, h);

        if (!engine || engine.errorHistory.length === 0) {
            ctx.fillStyle = '#64748b';
            ctx.font = '12px JetBrains Mono';
            ctx.textAlign = 'center';
            ctx.fillText('ÂÆüË°å„Åô„Çã„Å®ÂèéÊùüÊõ≤Á∑ö„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô', w / 2, h / 2);
            return;
        }

        const data = engine.errorHistory;
        const tolerance = parseFloat(document.getElementById('tolSelect').value);
        
        const pErrors = data.map(d => Math.log10(Math.max(d.maxP, 1e-16)));
        const qErrors = data.map(d => Math.log10(Math.max(d.maxQ, 1e-16)));
        const allErrors = [...pErrors, ...qErrors, Math.log10(tolerance)];
        
        const minLog = Math.min(...allErrors) - 1;
        const maxLog = Math.max(...allErrors) + 0.5;
        
        const plotW = w - padding.left - padding.right;
        const plotH = h - padding.top - padding.bottom;
        const xScale = plotW / Math.max(data.length, 5);
        const yScale = plotH / (maxLog - minLog);

        // Tolerance line
        const tolY = padding.top + (maxLog - Math.log10(tolerance)) * yScale;
        ctx.strokeStyle = '#ef4444';
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(padding.left, tolY);
        ctx.lineTo(w - padding.right, tolY);
        ctx.stroke();
        ctx.setLineDash([]);

        // P error curve
        ctx.strokeStyle = '#06b6d4';
        ctx.lineWidth = 2;
        ctx.beginPath();
        data.forEach((d, i) => {
            const x = padding.left + (i + 1) * xScale;
            const y = padding.top + (maxLog - Math.log10(Math.max(d.maxP, 1e-16))) * yScale;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Q error curve
        ctx.strokeStyle = '#ec4899';
        ctx.beginPath();
        data.forEach((d, i) => {
            const x = padding.left + (i + 1) * xScale;
            const y = padding.top + (maxLog - Math.log10(Math.max(d.maxQ, 1e-16))) * yScale;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Labels
        ctx.fillStyle = '#94a3b8';
        ctx.font = '11px JetBrains Mono';
        ctx.textAlign = 'center';
        ctx.fillText('ÂèçÂæ©ÂõûÊï∞', w / 2, h - 5);
    }

    function drawVoltageProfile() {
        const canvas = document.getElementById('voltageCanvas');
        const ctx = canvas.getContext('2d');
        const rect = canvas.parentElement.getBoundingClientRect();
        
        canvas.width = rect.width - 30;
        canvas.height = rect.height - 30;
        
        const w = canvas.width;
        const h = canvas.height;
        const padding = { top: 20, right: 20, bottom: 35, left: 55 };

        ctx.fillStyle = '#12121a';
        ctx.fillRect(0, 0, w, h);

        if (!engine) return;

        const results = engine.getBusResults();
        const voltages = results.map(r => r.V);
        
        const minV = Math.min(...voltages, 0.9);
        const maxV = Math.max(...voltages, 1.1);
        
        const plotW = w - padding.left - padding.right;
        const plotH = h - padding.top - padding.bottom;
        const barWidth = Math.max(plotW / results.length - 2, 5);

        // Safe zone
        const v095Y = padding.top + (maxV - 0.95) / (maxV - minV) * plotH;
        const v105Y = padding.top + (maxV - 1.05) / (maxV - minV) * plotH;
        
        ctx.fillStyle = 'rgba(34, 197, 94, 0.1)';
        ctx.fillRect(padding.left, v105Y, plotW, v095Y - v105Y);

        // Bars
        results.forEach((bus, i) => {
            const x = padding.left + i * (barWidth + 2);
            const barH = (bus.V - minV) / (maxV - minV) * plotH;
            const y = padding.top + plotH - barH;
            
            if (bus.type === 'Slack') ctx.fillStyle = '#10b981';
            else if (bus.type === 'PV') ctx.fillStyle = '#f59e0b';
            else ctx.fillStyle = '#3b82f6';
            
            ctx.fillRect(x, y, barWidth, barH);
        });

        ctx.fillStyle = '#94a3b8';
        ctx.font = '11px JetBrains Mono';
        ctx.textAlign = 'center';
        ctx.fillText('„Éé„Éº„ÉâÁï™Âè∑', w / 2, h - 5);
    }

    function drawJacobian() {
        const canvas = document.getElementById('jacobianCanvas');
        const ctx = canvas.getContext('2d');
        const rect = canvas.parentElement.getBoundingClientRect();
        
        canvas.width = rect.width - 30;
        canvas.height = rect.height - 30;
        
        const w = canvas.width;
        const h = canvas.height;

        ctx.fillStyle = '#12121a';
        ctx.fillRect(0, 0, w, h);

        if (!engine) return;

        const n = engine.nBus;
        const size = Math.min(w, h) * 0.9;
        const cellSize = Math.max(size / (2 * n), 2);
        const offsetX = (w - 2 * n * cellSize) / 2;
        const offsetY = (h - 2 * n * cellSize) / 2;

        for (let i = 0; i < n; i++) {
            for (let j = 0; j < n; j++) {
                const hasEntry = Math.abs(engine.Ybus.re[i][j]) > 1e-10 || 
                                Math.abs(engine.Ybus.im[i][j]) > 1e-10;
                
                if (hasEntry || i === j) {
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillRect(offsetX + j * cellSize, offsetY + i * cellSize, cellSize - 1, cellSize - 1);
                    
                    ctx.fillStyle = '#10b981';
                    ctx.fillRect(offsetX + (n + j) * cellSize, offsetY + i * cellSize, cellSize - 1, cellSize - 1);
                    
                    ctx.fillStyle = '#f59e0b';
                    ctx.fillRect(offsetX + j * cellSize, offsetY + (n + i) * cellSize, cellSize - 1, cellSize - 1);
                    
                    ctx.fillStyle = '#8b5cf6';
                    ctx.fillRect(offsetX + (n + j) * cellSize, offsetY + (n + i) * cellSize, cellSize - 1, cellSize - 1);
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
